<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éš¨æ©Ÿå‡ºé¡Œç³»çµ±</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body { 
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        
        .content {
            padding: 40px;
        }
        
        .name-input {
            width: 100%;
            padding: 12px 15px;
            font-size: 16px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            transition: all 0.3s;
            margin: 10px 0;
        }
        
        .name-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .source-section {
            margin: 20px 0;
        }
        
        .source-section label {
            font-weight: 600;
            color: #333;
            display: block;
            margin-bottom: 10px;
            font-size: 1.1em;
        }
        
        #source-list {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #e0e0e0;
        }
        
        #source-list label {
            display: block;
            padding: 8px 12px;
            margin: 5px 0;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: normal;
        }
        
        #source-list label:hover {
            background: #667eea;
            color: white;
            transform: translateX(5px);
        }
        
        #source-list input[type="checkbox"] {
            margin-right: 10px;
            cursor: pointer;
            width: 18px;
            height: 18px;
        }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 16px;
            font-weight: 600;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            margin: 10px 5px;
        }
        
        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }
        
        button:active:not(:disabled) {
            transform: translateY(0);
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .scoreboard {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .scoreboard > div {
            text-align: center;
        }
        
        .scoreboard .label {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 5px;
        }
        
        .scoreboard .value {
            font-size: 1.5em;
            font-weight: bold;
        }
        
        #question-text {
            font-size: 1.2em;
            line-height: 1.8;
            color: #333;
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #667eea;
            white-space: pre-wrap;
        }
        
        .question-img { 
            max-width: 100%;
            max-height: 400px;
            display: block;
            margin: 20px auto;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .img-loading {
            color: #666;
            font-style: italic;
            margin: 10px 0;
            text-align: center;
            padding: 20px;
        }
        
        .options {
            margin: 20px 0;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        
        .options label {
            display: flex;
            align-items: center;
            flex-direction: column;
            padding: 20px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            min-height: 150px;
            justify-content: center;
        }
        
        .options label:hover {
            border-color: #667eea;
            background: #f8f9ff;
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }
        
        .options input[type="radio"] {
            margin-bottom: 10px;
            cursor: pointer;
            width: 20px;
            height: 20px;
            accent-color: #667eea;
        }
        
        .options input[type="radio"]:disabled {
            cursor: not-allowed;
        }
        
        .option-content {
            text-align: center;
            width: 100%;
        }
        
        .option-label {
            font-weight: bold;
            font-size: 1.2em;
            color: #667eea;
            margin-bottom: 10px;
        }
        
        .option-img {
            max-width: 100%;
            max-height: 120px;
            margin-top: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .option-text {
            line-height: 1.6;
            margin-top: 10px;
            white-space: pre-wrap;
        }
        
        .result {
            font-weight: bold;
            font-size: 1.2em;
            margin: 20px 0;
            padding: 15px 20px;
            border-radius: 10px;
            text-align: center;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .result.correct {
            background: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }
        
        .result.wrong {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
        }
        
        .submit-section {
            margin: 30px 0;
            padding: 30px;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border-radius: 15px;
            color: white;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .submit-section h3 {
            font-size: 2em;
            margin-bottom: 20px;
        }
        
        .submit-section p {
            font-size: 1.2em;
            margin: 10px 0;
        }
        
        .submit-section button {
            background: white;
            color: #f5576c;
            margin: 10px;
        }
        
        .submit-section button:hover {
            background: #f8f9fa;
        }
        
        @media (max-width: 768px) {
            .content {
                padding: 20px;
            }
            
            .scoreboard {
                flex-direction: column;
                gap: 10px;
            }
            
            .header h1 {
                font-size: 1.5em;
            }
            
            .options {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“š éš¨æ©Ÿå‡ºé¡Œç³»çµ±</h1>
            <p>æ¸¬è©¦ä½ çš„çŸ¥è­˜ï¼ŒæŒ‘æˆ°è‡ªæˆ‘ï¼</p>
        </div>
        
        <div class="content">
            <div id="start-section">
                <div style="margin-bottom: 20px;">
                    <label style="font-weight: 600; color: #333; display: block; margin-bottom: 10px;">ğŸ‘¤ å§“å</label>
                    <input type="text" id="student-name" class="name-input" placeholder="è«‹è¼¸å…¥æ‚¨çš„å§“å">
                </div>
                
                <div class="source-section">
                    <label>ğŸ“– é¸æ“‡é¡Œåº«ä¾†æº</label>
                    <div id="source-list">è¼‰å…¥ä¸­...</div>
                </div>
                
                <div style="text-align: center; margin-top: 30px;">
                    <button id="start-btn" onclick="startQuiz()" disabled>ğŸš€ é–‹å§‹ç­”é¡Œ</button>
                </div>
            </div>
            
            <div id="quiz-area" style="display:none;">
                <div class="scoreboard">
                    <div>
                        <div class="label">å§“å</div>
                        <div class="value" id="display-name"></div>
                    </div>
                    <div>
                        <div class="label">ç­”é¡Œæ•¸</div>
                        <div class="value" id="answered">0</div>
                    </div>
                    <div>
                        <div class="label">æ­£ç¢ºç‡</div>
                        <div class="value" id="accuracy">0%</div>
                    </div>
                    <div>
                        <div class="label">â±ï¸ ä½œç­”æ™‚é–“</div>
                        <div class="value"><span id="timer">0</span>ç§’</div>
                    </div>
                </div>
                
                <div id="question-area">
                    <div id="question-text"></div>
                    <div id="img-loading" class="img-loading" style="display:none;">åœ–ç‰‡è¼‰å…¥ä¸­...</div>
                    <img id="question-img" class="question-img" style="display:none;" />
                    <div class="options" id="options"></div>
                </div>
                
                <div class="result" id="result"></div>
                
                <div style="text-align: center;">
                    <button onclick="nextQuestion()" id="next-btn" style="display:none;">â¡ï¸ ä¸‹ä¸€é¡Œ</button>
                </div>
                
                <div id="submit-section" class="submit-section" style="display:none;">
                    <div style="margin-top: 20px;">
                        <button onclick="submitRecord()" id="submit-btn">ğŸ“¤ æäº¤æˆç¸¾</button>
                        <button onclick="location.reload()">ğŸ”„ é‡æ–°é–‹å§‹</button>
                    </div>
                </div>
                
                <div id="review-section" style="display:none; margin-top: 30px;">
                    <h3 style="color: #333; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 3px solid #667eea;">ğŸ“ éŒ¯é¡Œå›é¡§</h3>
                    <div id="wrong-questions-list"></div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbx9M8hUSkPFDqVccEH7rn9Orrd5SP3Sq--7SOaJ2ml3vlS5ZZDL_EifLwEw_cr4vrjq/exec';

        let allQuestions = [];
        let filteredQuestions = [];
        let currentQuestion = null;
        let score = 0, answered = 0;
        let allSources = [];
        let studentName = '';
        let startTime = null;
        let timerInterval = null;
        let correctIds = [];
        let wrongIds = [];
        let wrongQuestions = [];
        let questionCounter = 0;
        let currentOptionsMapping = {};

        function renderSourceList(sources) {
            const list = document.getElementById('source-list');
            if (sources.length === 0) {
                list.innerHTML = 'ç„¡å¯ç”¨é¡Œåº«ä¾†æº';
                document.getElementById('start-btn').disabled = true;
                return;
            }
            list.innerHTML = sources.map(src =>
                `<label><input type="checkbox" value="${src}" checked> ${src}</label>`
            ).join('');
            document.getElementById('start-btn').disabled = false;
        }

        async function fetchQuestions() {
            try {
                const res = await fetch(API_URL + '?action=getQuestions');
                if (!res.ok) throw new Error('API å›æ‡‰å¤±æ•—: ' + res.status);
                const data = await res.json();
                if (!Array.isArray(data) || data.length === 0) {
                    document.getElementById('source-list').innerHTML = 'ç„¡æ³•å–å¾—é¡Œåº«è³‡æ–™ï¼Œè«‹æª¢æŸ¥ API æˆ– Google Sheet';
                    return;
                }
                allQuestions = data;
                allSources = Array.from(new Set(allQuestions.map(q => q.å‡ºè™•))).filter(Boolean);
                renderSourceList(allSources);
            } catch (err) {
                document.getElementById('source-list').innerHTML = 'è¼‰å…¥å¤±æ•—: ' + err.message;
            }
        }

        function startTimer() {
            startTime = Date.now();
            timerInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                document.getElementById('timer').textContent = elapsed;
            }, 1000);
        }

        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
            }
        }

        function getElapsedTime() {
            return Math.floor((Date.now() - startTime) / 1000);
        }

        function formatTime(seconds) {
            if (seconds < 60) {
                return seconds + 'ç§’';
            }
            const minutes = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${minutes}åˆ†${secs}ç§’`;
        }

        async function startQuiz() {
            studentName = document.getElementById('student-name').value.trim();
            if (!studentName) {
                alert('è«‹è¼¸å…¥å§“åï¼');
                return;
            }
            
            if (allQuestions.length === 0) {
                await fetchQuestions();
            }
            const checked = Array.from(document.querySelectorAll('#source-list input:checked')).map(i => i.value);
            filteredQuestions = allQuestions.filter(q => checked.includes(q.å‡ºè™•));
            if (filteredQuestions.length === 0) {
                alert('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹é¡Œåº«ä¾†æºï¼');
                return;
            }
            
            score = 0; 
            answered = 0;
            correctIds = [];
            wrongIds = [];
            wrongQuestions = [];
            questionCounter = 0;
            
            document.getElementById('display-name').textContent = studentName;
            document.getElementById('answered').textContent = answered;
            document.getElementById('accuracy').textContent = '0%';
            document.getElementById('start-section').style.display = 'none';
            document.getElementById('quiz-area').style.display = '';
            document.getElementById('result').textContent = '';
            
            startTimer();
            nextQuestion();
        }

        function isUrl(str) {
            if (!str) return false;
            return str.trim().startsWith('http://') || str.trim().startsWith('https://');
        }

        function convertDriveUrl(url) {
            if (!url) return null;
            url = url.trim();
            let match = url.match(/\/file\/d\/([a-zA-Z0-9_-]+)/);
            if (match) return `https://drive.google.com/uc?export=view&id=${match[1]}`;
            match = url.match(/[?&]id=([a-zA-Z0-9_-]+)/);
            if (match && url.includes('drive.google.com')) return `https://drive.google.com/uc?export=view&id=${match[1]}`;
            match = url.match(/thumbnail\?id=([a-zA-Z0-9_-]+)/);
            if (match) return `https://drive.google.com/uc?export=view&id=${match[1]}`;
            match = url.match(/\/d\/([a-zA-Z0-9_-]+)/);
            if (match) return `https://drive.google.com/uc?export=view&id=${match[1]}`;
            return url;
        }
        
        function loadImage(url, retryCount = 0) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                const timeout = setTimeout(() => {
                    img.src = '';
                    reject(new Error('åœ–ç‰‡è¼‰å…¥è¶…æ™‚'));
                }, 10000);
                
                img.onload = () => {
                    clearTimeout(timeout);
                    resolve(url);
                };
                
                img.onerror = () => {
                    clearTimeout(timeout);
                    if (retryCount === 0) {
                        const match = url.match(/[?&]id=([a-zA-Z0-9_-]+)/);
                        if (match && !url.includes('thumbnail')) {
                            const thumbnailUrl = `https://drive.google.com/thumbnail?id=${match[1]}&sz=w800`;
                            loadImage(thumbnailUrl, 1).then(resolve).catch(reject);
                            return;
                        }
                    }
                    reject(new Error('åœ–ç‰‡è¼‰å…¥å¤±æ•—'));
                };
                
                img.src = url;
            });
        }
        
        async function displayImage(url, imgElementId, loadingElementId) {
            const imgElement = document.getElementById(imgElementId);
            const loadingElement = loadingElementId ? document.getElementById(loadingElementId) : null;
            
            if (!url) {
                imgElement.style.display = 'none';
                if (loadingElement) loadingElement.style.display = 'none';
                return;
            }
            
            imgElement.style.display = 'none';
            if (loadingElement) {
                loadingElement.style.display = 'block';
                loadingElement.textContent = 'åœ–ç‰‡è¼‰å…¥ä¸­...';
            }
            
            try {
                const finalUrl = await loadImage(url);
                imgElement.src = finalUrl;
                imgElement.style.display = 'block';
                if (loadingElement) loadingElement.style.display = 'none';
            } catch (error) {
                imgElement.style.display = 'none';
                if (loadingElement) {
                    loadingElement.style.display = 'block';
                    loadingElement.textContent = 'âš ï¸ åœ–ç‰‡è¼‰å…¥å¤±æ•—';
                    loadingElement.style.color = '#ff6b6b';
                    setTimeout(() => loadingElement.style.display = 'none', 3000);
                }
            }
        }
        
        async function displayOptionImage(url, imgElement, errorSpan) {
            if (!url) {
                imgElement.style.display = 'none';
                return;
            }
            try {
                const finalUrl = await loadImage(url);
                imgElement.src = finalUrl;
                imgElement.style.display = 'inline-block';
            } catch (error) {
                imgElement.style.display = 'none';
                errorSpan.style.display = 'inline';
            }
        }

        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }

        function nextQuestion() {
            const resultDiv = document.getElementById('result');
            resultDiv.textContent = '';
            resultDiv.className = 'result';
            document.getElementById('next-btn').style.display = 'none';
            
            if (filteredQuestions.length === 0) {
                stopTimer();
                const finalTime = getElapsedTime();
                
                document.getElementById('question-area').style.display = 'none';
                
                // è‡ªå‹•æäº¤æˆç¸¾
                submitRecord();
                
                // å¦‚æœæœ‰éŒ¯é¡Œï¼Œé¡¯ç¤ºéŒ¯é¡Œå›é¡§
                if (wrongQuestions.length > 0) {
                    document.getElementById('review-section').style.display = 'block';
                    displayWrongQuestions();
                } else {
                    // æ²’æœ‰éŒ¯é¡Œï¼Œç›´æ¥é¡¯ç¤ºé‡æ–°é–‹å§‹æŒ‰éˆ•
                    document.getElementById('submit-section').style.display = '';
                }
                
                return;
            }
            
            const idx = Math.floor(Math.random() * filteredQuestions.length);
            currentQuestion = filteredQuestions.splice(idx, 1)[0];
            
            document.getElementById('question-text').textContent = currentQuestion.é¡Œç›®;
            
            const imageUrl = convertDriveUrl(currentQuestion.åœ–ç‰‡ç¶²å€);
            displayImage(imageUrl, 'question-img', 'img-loading');
            
            questionCounter++;
            const optionGroupName = 'question_' + questionCounter;
            
            const optionsContainer = document.getElementById('options');
            optionsContainer.innerHTML = '';
            
            const originalOptions = ['A', 'B', 'C', 'D'];
            const shuffledContent = shuffleArray([...originalOptions]);
            currentOptionsMapping = {};
            
            originalOptions.forEach((displayLabel, index) => {
                const actualAnswer = shuffledContent[index];
                const optionContent = currentQuestion[actualAnswer];
                currentOptionsMapping[displayLabel] = actualAnswer;
                
                const label = document.createElement('label');
                const input = document.createElement('input');
                input.type = 'radio';
                input.name = optionGroupName;
                input.value = displayLabel;
                input.onclick = checkAnswer;
                label.appendChild(input);
                
                const labelDiv = document.createElement('div');
                labelDiv.className = 'option-label';
                labelDiv.textContent = displayLabel;
                label.appendChild(labelDiv);
                
                const contentDiv = document.createElement('div');
                contentDiv.className = 'option-content';
                
                if (isUrl(optionContent)) {
                    const imgUrl = convertDriveUrl(optionContent);
                    const img = document.createElement('img');
                    img.className = 'option-img';
                    img.alt = `${displayLabel} é¸é …åœ–ç‰‡`;
                    img.style.display = 'none';
                    
                    const errorSpan = document.createElement('span');
                    errorSpan.style.display = 'none';
                    errorSpan.style.color = '#ff6b6b';
                    errorSpan.textContent = 'âŒ åœ–ç‰‡è¼‰å…¥å¤±æ•—';
                    
                    contentDiv.appendChild(img);
                    contentDiv.appendChild(errorSpan);
                    displayOptionImage(imgUrl, img, errorSpan);
                } else {
                    const span = document.createElement('span');
                    span.className = 'option-text';
                    span.textContent = optionContent;
                    contentDiv.appendChild(span);
                }
                
                label.appendChild(contentDiv);
                optionsContainer.appendChild(label);
            });
        }

        function checkAnswer(e) {
            const selectedPosition = e.target.value;
            const actualAnswer = currentOptionsMapping[selectedPosition];
            
            answered++;
            const questionId = currentQuestion.é¡Œç›®ID;
            
            const resultDiv = document.getElementById('result');
            
            if (actualAnswer === currentQuestion.æ­£ç¢ºç­”æ¡ˆ) {
                score++;
                correctIds.push(questionId);
                resultDiv.textContent = `âœ”ï¸ æ­£ç¢ºï¼ä½ é¸æ“‡äº† ${selectedPosition}`;
                resultDiv.className = 'result correct';
            } else {
                wrongIds.push(questionId);
                wrongQuestions.push({
                    question: currentQuestion,
                    userAnswer: actualAnswer,
                    correctAnswer: currentQuestion.æ­£ç¢ºç­”æ¡ˆ
                });
                
                let correctPosition = '';
                for (let pos in currentOptionsMapping) {
                    if (currentOptionsMapping[pos] === currentQuestion.æ­£ç¢ºç­”æ¡ˆ) {
                        correctPosition = pos;
                        break;
                    }
                }
                resultDiv.textContent = `âŒ éŒ¯èª¤ï¼æ­£ç¢ºç­”æ¡ˆæ˜¯ ${correctPosition}`;
                resultDiv.className = 'result wrong';
            }
            
            document.getElementById('answered').textContent = answered;
            document.getElementById('accuracy').textContent = ((score/answered)*100).toFixed(1) + '%';
            
            document.querySelectorAll('input[name="' + e.target.name + '"]').forEach(input => input.disabled = true);
            document.getElementById('next-btn').style.display = '';
        }

        function displayWrongQuestions() {
            const container = document.getElementById('wrong-questions-list');
            container.innerHTML = '';
            
            wrongQuestions.forEach((item, index) => {
                const q = item.question;
                const wrongCard = document.createElement('div');
                wrongCard.style.cssText = 'background: white; border: 2px solid #ff6b6b; border-radius: 15px; padding: 25px; margin-bottom: 25px; box-shadow: 0 4px 10px rgba(255, 107, 107, 0.1);';
                
                const questionTitle = document.createElement('div');
                questionTitle.style.cssText = 'font-size: 1.1em; font-weight: bold; color: #333; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #f0f0f0;';
                questionTitle.innerHTML = `<span style="color: #ff6b6b;">âŒ ç¬¬ ${index + 1} é¡Œ</span><br><span style="font-weight: normal; margin-top: 8px; display: inline-block;">${q.é¡Œç›®}</span>`;
                wrongCard.appendChild(questionTitle);
                
                // ä¿®æ­£é¡Œç›®åœ–ç‰‡è¼‰å…¥
                if (q.åœ–ç‰‡ç¶²å€ && isUrl(q.åœ–ç‰‡ç¶²å€)) {
                    const qImg = document.createElement('img');
                    qImg.style.cssText = 'max-width: 100%; max-height: 300px; display: block; margin: 15px auto; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);';
                    wrongCard.appendChild(qImg);
                    
                    // ä½¿ç”¨ loadImage å‡½æ•¸éåŒæ­¥è¼‰å…¥
                    const imageUrl = convertDriveUrl(q.åœ–ç‰‡ç¶²å€);
                    loadImage(imageUrl).then(finalUrl => {
                        qImg.src = finalUrl;
                    }).catch(() => {
                        qImg.style.display = 'none';
                    });
                }
                
                const optionsDiv = document.createElement('div');
                optionsDiv.style.cssText = 'display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-top: 15px;';
                
                ['A', 'B', 'C', 'D'].forEach(opt => {
                    const optDiv = document.createElement('div');
                    const isCorrect = opt === q.æ­£ç¢ºç­”æ¡ˆ;
                    const isUserChoice = opt === item.userAnswer;
                    
                    let borderColor = '#e0e0e0';
                    let bgColor = 'white';
                    if (isCorrect) {
                        borderColor = '#4CAF50';
                        bgColor = '#e8f5e9';
                    } else if (isUserChoice) {
                        borderColor = '#ff6b6b';
                        bgColor = '#ffebee';
                    }
                    
                    optDiv.style.cssText = `padding: 15px; border: 2px solid ${borderColor}; background: ${bgColor}; border-radius: 10px; min-height: 100px; display: flex; flex-direction: column; align-items: center; justify-content: center;`;
                    
                    const label = document.createElement('div');
                    label.style.cssText = `font-weight: bold; margin-bottom: 8px; color: ${isCorrect ? '#4CAF50' : isUserChoice ? '#ff6b6b' : '#667eea'};`;
                    
                    let labelText = opt;
                    if (isCorrect) labelText += ' âœ“ (æ­£ç¢ºç­”æ¡ˆ)';
                    if (isUserChoice && !isCorrect) labelText += ' (ä½ çš„ç­”æ¡ˆ)';
                    label.textContent = labelText;
                    optDiv.appendChild(label);
                    
                    const content = q[opt];
                    if (isUrl(content)) {
                        // ä¿®æ­£é¸é …åœ–ç‰‡è¼‰å…¥
                        const img = document.createElement('img');
                        img.style.cssText = 'max-width: 100%; max-height: 100px; border-radius: 8px;';
                        optDiv.appendChild(img);
                        
                        const imgUrl = convertDriveUrl(content);
                        loadImage(imgUrl).then(finalUrl => {
                            img.src = finalUrl;
                        }).catch(() => {
                            img.style.display = 'none';
                            const errorText = document.createElement('span');
                            errorText.textContent = 'âŒ åœ–ç‰‡è¼‰å…¥å¤±æ•—';
                            errorText.style.color = '#ff6b6b';
                            optDiv.appendChild(errorText);
                        });
                    } else {
                        const text = document.createElement('div');
                        text.textContent = content;
                        text.style.cssText = 'text-align: center; line-height: 1.6;';
                        optDiv.appendChild(text);
                    }
                    
                    optionsDiv.appendChild(optDiv);
                });
                
                wrongCard.appendChild(optionsDiv);
                container.appendChild(wrongCard);
            });

            // åœ¨æ‰€æœ‰éŒ¯é¡Œå¾Œé¢åŠ å…¥é‡æ–°é–‹å§‹æŒ‰éˆ•
            const restartDiv = document.createElement('div');
            restartDiv.style.cssText = 'text-align: center; margin-top: 30px; padding: 20px;';
            const restartBtn = document.createElement('button');
            restartBtn.textContent = 'ğŸ”„ é‡æ–°é–‹å§‹';
            restartBtn.onclick = () => location.reload();
            restartDiv.appendChild(restartBtn);
            container.appendChild(restartDiv);
        }

        async function submitRecord() {
            const duration = getElapsedTime();
            const accuracy = ((score/answered)*100).toFixed(1) + '%';
            
            const formData = new URLSearchParams();
            formData.append('action', 'saveRecord');
            formData.append('name', studentName);
            formData.append('duration', duration);
            formData.append('correctCount', score);
            formData.append('correctIds', correctIds.join(', '));
            formData.append('wrongCount', answered - score);
            formData.append('wrongIds', wrongIds.join(', '));
            formData.append('accuracy', accuracy);
            
            try {
                const res = await fetch(API_URL, {
                    method: 'POST',
                    body: formData
                });
                
                const text = await res.text();
                let result;
                try {
                    result = JSON.parse(text);
                } catch (e) {
                    throw new Error('ä¼ºæœå™¨å›æ‡‰æ ¼å¼éŒ¯èª¤');
                }
                
                if (!result.success) {
                    // åªåœ¨å¤±æ•—æ™‚é¡¯ç¤º alert
                    alert('âŒ æˆç¸¾æäº¤å¤±æ•—: ' + (result.error || 'æœªçŸ¥éŒ¯èª¤'));
                }
                // æˆåŠŸæ™‚ä¸é¡¯ç¤º alertï¼Œéœé»˜æäº¤
            } catch (err) {
                alert('âŒ æäº¤å¤±æ•—: ' + err.message);
            }
        }

        window.onload = fetchQuestions;
    </script>
</body>
</html>
